<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Premium Sports Web Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#0c0c0f;--panel:#121218;--panel-2:#181826;--panel-3:#1f1f2e;
      --text:#f5f6f9;--muted:#9aa0ad;--brand:#ff3348;--ok:#17c964;--warn:#f5a524;
      --fc:#ff6b00;--sl:#00a8ff;--ch:#ffcc00;
      --radius:14px;--shadow:0 10px 30px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b0b10,#0c0c0f 120px);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:40;background:linear-gradient(90deg,#0d0d14,#13131b);border-bottom:1px solid #1c1c29}
    .nav{max-width:1200px;margin:0 auto;height:64px;display:flex;align-items:center;gap:12px;padding:0 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand i{color:var(--brand)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--panel-2);color:var(--muted);cursor:pointer;border:1px solid #23233a}
    .chip.active{color:var(--text);background:var(--panel-3);border-color:#32324a}
    .spacer{flex:1}
    .search{display:flex;align-items:center;gap:8px;background:#141422;border:1px solid #23233a;border-radius:999px;padding:8px 12px;min-width:260px}
    .search input{all:unset;color:var(--text);width:220px}
    .toolbar{max-width:1200px;margin:10px auto 0;display:flex;gap:8px;padding:0 16px;flex-wrap:wrap}
    .btn{background:#181828;border:1px solid #23233a;color:#dfe2ea;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.active{border-color:var(--brand);color:#fff}
    .btn.ghost{background:transparent}
    .grid{max-width:1200px;margin:14px auto;padding:0 16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .card{background:var(--panel);border:1px solid #23233a;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);transition:transform .18s ease, border-color .2s}
    .card:hover{transform:translateY(-2px);border-color:#3a3a5a}
    .thumb{position:relative;height:168px;background:#141421}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;opacity:0;transition:opacity .3s ease}
    .thumb img.loaded{opacity:1}
    .badge{position:absolute;top:10px;left:10px;padding:6px 9px;border-radius:999px;font-size:12px;font-weight:700}
    .live{background:linear-gradient(90deg,#ff3348,#ff006a);color:#fff}
    .upc{background:#1c3bff;color:#fff}
    .flag{position:absolute;top:10px;right:10px;padding:6px 9px;border-radius:999px;font-size:12px;font-weight:700}
    .flag.fc{background:linear-gradient(90deg,#ff7a00,#ff6b00);color:#111}
    .flag.sl{background:linear-gradient(90deg,#00a8ff,#4ecbff);color:#081018}
    .flag.ch{background:linear-gradient(90deg,#ffcc00,#ffdd66);color:#111}
    .body{padding:12px}
    .title{font-weight:700;margin:2px 0 6px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .pill{background:#1a1a2a;border:1px solid #26263d;padding:4px 8px;border-radius:999px;font-size:12px;color:#bfc3d2}
    .empty{grid-column:1/-1;background:var(--panel);border:1px dashed #2a2a45;border-radius:var(--radius);padding:28px;text-align:center;color:var(--muted)}
    footer.note{max-width:1200px;margin:8px auto 24px;color:#7f8796;padding:0 16px}
    /* player */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.86);backdrop-filter:saturate(110%) blur(4px);display:none;align-items:center;justify-content:center;z-index:50}
    .player{width:min(92vw,980px);background:#0f0f17;border:1px solid #2b2b44;border-radius:16px;box-shadow:var(--shadow);padding:14px}
    .player-head{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .player-head .title{flex:1}
    .player video{width:100%;border-radius:10px;background:#000}
    .player .meta{margin-top:10px;color:#aab1bf;font-size:13px}
    .player .actions{display:flex;gap:8px;margin-left:auto}
    .ghost-link{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:10px;border:1px dashed #2a93ff33;color:#9bd2ff;background:#0b2338}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand"><i class="fa-solid fa-play-circle"></i> <span>Premium Sports Player</span></div>
      <button class="chip active" id="src-all"><i class="fa-solid fa-layer-group"></i> All</button>
      <button class="chip" id="src-fc"><i class="fa-solid fa-tv"></i> FanCode</button>
      <button class="chip" id="src-sl"><i class="fa-solid fa-broadcast-tower"></i> SonyLIV</button>
      <button class="chip" id="src-ch"><i class="fa-solid fa-cricket"></i> CricHd</button>
      <div class="spacer"></div>
      <div class="search"><i class="fa-solid fa-magnifying-glass"></i><input id="q" placeholder="Search teams, leagues, events…" /></div>
    </div>
  </header>

  <div class="toolbar">
    <button class="btn active" id="tab-live"><i class="fa-solid fa-circle-dot"></i> Live</button>
    <button class="btn" id="tab-upc"><i class="fa-regular fa-clock"></i> Upcoming</button>

    <button class="btn ghost" data-sport="all">All Sports</button>
    <button class="btn" data-sport="Cricket">Cricket</button>
    <button class="btn" data-sport="Football">Football</button>
    <button class="btn" data-sport="Basketball">Basketball</button>
    <button class="btn" data-sport="Tennis">Tennis</button>
    <button class="btn" data-sport="Hockey">Hockey</button>

    <div class="spacer"></div>
    <button class="btn ghost" id="refresh-now" title="R key also refreshes"><i class="fa-solid fa-rotate"></i> Refresh</button>
    <span class="muted" id="last-updated"></span>
  </div>

  <main class="grid" id="grid">
    <div class="empty" id="placeholder">loading matches…</div>
  </main>

  <footer class="note">tips: <kbd>/</kbd> to focus search • <kbd>R</kbd> to refresh • your filters auto-save</footer>

  <div class="overlay" id="overlay">
    <div class="player">
      <div class="player-head">
        <div class="title" id="play-title">Loading…</div>
        <div class="actions" id="player-actions"></div>
        <button class="btn" id="close"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <video id="video" controls playsinline></video>
      <div class="meta" id="play-meta"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8"></script>
  <script>
    // ---------- CONFIG ----------
    const API_FC = "https://raw.githubusercontent.com/drmlive/fancode-live-events/main/fancode.json";
    const API_SL = "https://raw.githubusercontent.com/drmlive/sliv-live-events/refs/heads/main/sonyliv.json";
    const API_CH = "https://raw.githubusercontent.com/abusaeeidx/CricHd-playlists-Auto-Update-permanent/main/api.json";
    const PAGE_SIZE = 18;
    const REFRESH_BASE_MS = 60_000;

    const state = {
      dataset: [],
      filtered: [],
      sliceEnd: PAGE_SIZE,
      source: loadPref("source","all"),
      status: loadPref("status","live"),
      sport : loadPref("sport","all"),
      q: loadPref("q",""),
      backoff: 0,
      hls: null
    };

    const grid = document.getElementById("grid");
    const placeholder = document.getElementById("placeholder");
    const q = document.getElementById("q");
    const lastUpdated = document.getElementById("last-updated");
    const overlay = document.getElementById("overlay");
    const videoEl = document.getElementById("video");
    const playTitle = document.getElementById("play-title");
    const playMeta = document.getElementById("play-meta");
    const playerActions = document.getElementById("player-actions");

    document.getElementById("src-all").onclick = () => setSource("all");
    document.getElementById("src-fc").onclick  = () => setSource("fc");
    document.getElementById("src-sl").onclick  = () => setSource("sl");
    document.getElementById("src-ch").onclick  = () => setSource("ch");
    document.getElementById("tab-live").onclick = () => setStatus("live");
    document.getElementById("tab-upc").onclick  = () => setStatus("upc");
    document.getElementById("refresh-now").onclick = refreshNow;
    document.getElementById("close").onclick = closePlayer;
    q.oninput = () => { state.q = q.value.trim(); savePref("q",state.q); applyFilters(); };

    document.querySelectorAll('.toolbar .btn[data-sport]').forEach(btn=>{
      btn.onclick = () => {
        document.querySelectorAll('.toolbar .btn[data-sport]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        state.sport = btn.dataset.sport;
        savePref("sport",state.sport);
        applyFilters();
      };
      if(btn.dataset.sport === state.sport) btn.classList.add('active');
    });

    initActives();

    window.addEventListener('keydown', (e)=>{
      if(e.key==='/'){ e.preventDefault(); q.focus(); q.select(); }
      if(e.key.toLowerCase()==='r'){ refreshNow(); }
      if(e.key==='Escape' && overlay.style.display==='flex'){ closePlayer(); }
    });

    const imgObserver = new IntersectionObserver(entries=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          const img = entry.target;
          img.src = img.dataset.src;
          img.onload = ()=>img.classList.add('loaded');
          imgObserver.unobserve(img);
        }
      });
    },{rootMargin:"200px 0px"});

    window.addEventListener('scroll', ()=>{
      if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 300){
        if(state.sliceEnd < state.filtered.length){
          state.sliceEnd += PAGE_SIZE;
          render();
        }
      }
    });

    let refreshTimer;
    function scheduleRefresh(){
      clearTimeout(refreshTimer);
      const delay = REFRESH_BASE_MS * Math.max(1, state.backoff || 1);
      refreshTimer = setTimeout(loadAll, delay);
    }

    async function loadAll(){
      placeholder.textContent = "loading matches…";
      try{
        const [fcRes, slRes, chRes] = await Promise.allSettled([
          fetch(API_FC, {cache:"no-store"}),
          fetch(API_SL, {cache:"no-store"}),
          fetch(API_CH, {cache:"no-store"})
        ]);

        const fc = fcRes.status==="fulfilled" && fcRes.value.ok ? (await fcRes.value.json()).matches ?? [] : [];
        const sl = slRes.status==="fulfilled" && slRes.value.ok ? (await slRes.value.json()).matches ?? [] : [];
        const ch = chRes.status==="fulfilled" && chRes.value.ok ? (await chRes.value.json()).matches ?? [] : [];

        const normFC = fc.map(m=>({provider:"FanCode", providerKey:"fc", title:m.match_name||m.title||m.event_name||"Untitled", category:m.event_category||"Sports", league:m.event_name||"", teams:(m.team_1&&m.team_2)?`${m.team_1} vs ${m.team_2}`:"", start:m.startTime||"", status:(m.status||"").toUpperCase()==="LIVE"?"LIVE":"UPCOMING", img:m.src||"", hls:m.adfree_url||m.dai_url||"", raw:m}));
        const normSL = sl.map(m=>({provider:"SonyLIV", providerKey:"sl", title:m.match_name||m.event_name||"Untitled", category:m.event_category||"Sports", league:m.event_name||"", teams:"", start:m.startTime||"", status:m.isLive?"LIVE":"UPCOMING", img:m.src||"", hls:m.dai_url||m.pub_url||m.video_url||"", contentId:m.contentId, broadcast:m.broadcast_channel||"", audio:m.audioLanguageName||"", raw:m}));
        const normCH = ch.map(m=>({provider:"CricHd", providerKey:"ch", title:m.match_name||m.title||m.event_name||"Untitled", category:m.event_category||"Cricket", league:m.event_name||"", teams:(m.team_1&&m.team_2)?`${m.team_1} vs ${m.team_2}`:"", start:m.startTime||"", status:m.isLive?"LIVE":"UPCOMING", img:m.src||"", hls:m.hls_url||m.stream_url||"", raw:m}));

        const unified = [...normFC, ...normSL, ...normCH];

        state.backoff = 0;
        updateLastUpdated();
        scheduleRefresh();
        state.dataset = filterBySource(unified, state.source);
        applyFilters(true);
      }catch(err){
        console.error(err);
        state.backoff = Math.min((state.backoff||1)*2, 8);
        placeholder.textContent = "failed to load. will retry…";
        scheduleRefresh();
      }
    }

    function updateLastUpdated(){
      const d = new Date();
      lastUpdated.textContent = `updated ${d.toLocaleTimeString()}`;
    }

    function filterBySource(list, src){
      if(src==="fc") return list.filter(x=>x.providerKey==="fc");
      if(src==="sl") return list.filter(x=>x.providerKey==="sl");
      if(src==="ch") return list.filter(x=>x.providerKey==="ch");
      return list;
    }

    function applyFilters(resetSlice=false){
      let arr = [...state.dataset];
      arr = arr.filter(x => state.status==="live" ? x.status==="LIVE" : x.status!=="LIVE");
      if(state.sport!=="all"){ arr = arr.filter(x => (x.category||"").toLowerCase() === state.sport.toLowerCase()); }
      const qv = state.q.toLowerCase();
      if(qv){ arr = arr.filter(x => (x.title+""+x.teams).toLowerCase().includes(qv)); }
      state.filtered = arr;
      if(resetSlice) state.sliceEnd = PAGE_SIZE;
      render();
    }

    function render(){
      grid.innerHTML="";
      const slice = state.filtered.slice(0,state.sliceEnd);
      if(slice.length===0){ placeholder.textContent="no matches found"; grid.appendChild(placeholder); return; }
      slice.forEach(m=>{
        const c=document.createElement("div"); c.className="card";
        c.innerHTML=`<div class="thumb"><img data-src="${m.img}" alt="${m.title}"><span class="badge ${m.status==="LIVE"?"live":"upc"}">${m.status}</span></div>
        <div class="body"><div class="title">${m.title}</div><div class="muted">${m.teams||m.league||m.category}</div></div>`;
        c.onclick = ()=>playMatch(m);
        grid.appendChild(c);
        imgObserver.observe(c.querySelector("img"));
      });
    }

    function playMatch(m){
      overlay.style.display="flex";
      playTitle.textContent = m.title;
      playMeta.textContent = `${m.teams||m.league||m.category} | ${m.provider}`;
      playerActions.innerHTML=`<a class="ghost-link" href="${m.hls}" target="_blank">Open in new tab</a>`;
      if(Hls.isSupported()){
        if(state.hls){ state.hls.destroy(); }
        state.hls = new Hls();
        state.hls.loadSource(m.hls);
        state.hls.attachMedia(videoEl);
        state.hls.on(Hls.Events.MANIFEST_PARSED,()=>{ videoEl.play(); });
      } else { videoEl.src = m.hls; videoEl.play(); }
    }

    function closePlayer(){
      overlay.style.display="none";
      if(state.hls){ state.hls.destroy(); state.hls=null; }
      videoEl.pause(); videoEl.src="";
    }

    function refreshNow(){ loadAll(); }

    function setSource(src){
      state.source = src;
      savePref("source",src);
      document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      document.getElementById("src-"+src).classList.add('active');
      state.dataset = filterBySource([...state.dataset], src);
      applyFilters(true);
    }

    function setStatus(status){
      state.status = status;
      savePref("status",status);
      document.querySelectorAll('#tab-live,#tab-upc').forEach(b=>b.classList.remove('active'));
      document.getElementById("tab-"+status).classList.add('active');
      applyFilters(true);
    }

    function loadPref(k,d){ try{return localStorage.getItem(k)||d}catch(e){return d} }
    function savePref(k,v){ try{localStorage.setItem(k,v)}catch(e){} }

    function initActives(){
      document.getElementById("src-"+state.source)?.classList.add("active");
      document.getElementById("tab-"+state.status)?.classList.add("active");
    }

    loadAll();
  </script>
</body>
</html>
